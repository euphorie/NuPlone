<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n" 
      xmlns:meta="http://xml.zope.org/namespaces/meta"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      meta:interpolation="true"
      i18n:domain="nuplone"
      tal:define="tools context/@@tools">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" media="all" href="${tools/portal/++resource++NuPlone.z3cform.style}/base.css"/>
  </head>
  <body id="links" class="dropSheet">
    <h1 i18n:translate="header_place_link">Place a Link</h1>

    <div id="external" class="formSection">
      <form action="${request/getURL}" method="${view/method}" enctype="${view/enctype}">
        <fieldset class="concise">
          <tal:widget replace="structure view/widgets/URL/render" />
          <tal:widget replace="structure view/widgets/title/render" />
          <tal:widget replace="structure view/widgets/new_window/render" />
        </fieldset>
        <div class="buttonBar">
          <button name="form.buttons.save" class="save" type="button" i18n:translate="button_save_changes">Save changes</button>
          <button name="form.buttons.cancel" class="cancel" type="button" i18n:translate="button_cancel">Cancel</button>
        </div>
      </form>
    </div>
    <script type="text/javascript" src="${tools/portal/++resource++NuPlone.libraries}/jquery-1.4.2.js"></script>
    <script type="text/javascript" src="${tools/portal/++resource++NuPlone.libraries}/jquery.form.js"></script>
    <script type="text/javascript" meta:interpolation="false">
// <![CDATA[
    function reset() {
        $("input[type=text]").val(null);
        $("input[type=checkbox]").attr("checked", "checked");
        $("em.message.warning").remove();
    }

    function hide() {
        var topDoc = window.frameElement.ownerDocument;
        $("#linkFrame", topDoc).hide();
    }


    function show(el) {
        var topDoc = window.frameElement.ownerDocument;

        if (el===undefined) {
            reset();
        } else {
            var topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow,
                $link = $(el),
                link = $link.attr("href") || "",
                title = $link.attr("title") || "",
                newwindow = $link.attr("target")==="_blank";
            
            topWindow.getSelection().selectAllChildren(el);
            $("input[name=form.widgets.new_window:list]").get(0).checked = newwindow;
            $("input[name=form.widgets.URL]").val(link);
            $("input[name=form.widgets.title]").val(title);
        }

        $("#linkFrame", topDoc).show();
    }


    function getSelectionAnchor(window, document) {
        if (window.getSelection) {
            return window.getSelection().anchorNode;
        } else {
            // Internet Explorer
            return document.selection.createRange().parentElement();
        }
    }

    // http://www.quirksmode.org/dom/range_intro.html
    function getSelectionObject(window, document) {
        if (window.getSelection) {
            return window.getSelection();
        } else {
            return document.selection.createRange();
        }
    } 

    // http://www.quirksmode.org/dom/range_intro.html
    function getRangeObject(selectionObject) {
        if (selectionObject.getRangeAt) {
              return selectionObject.getRangeAt(0);
        } else { // Safari!
            var range = document.createRange();
            range.setStart(selectionObject.anchorNode,selectionObject.anchorOffset);
            range.setEnd(selectionObject.focusNode,selectionObject.focusOffset);
            return range;
        }
    }

    function removeLink() {
        var topDoc = window.frameElement.ownerDocument,
            topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow,
            $anchor = $(getSelectionAnchor(topWindow, topDoc)),
            $link;

        // XXX: handle IE where there is no selection and we need to create a new range based on
        // the cursor position 
        $link=$anchor.closest("a");
        if (!$link.length){
            return;
        }

        $link.replaceWith($link.contents());
    }


    function InsertURL(url, title, newwindow) {
        var topDoc = window.frameElement.ownerDocument,
            topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow,
            selection = getSelectionObject(topWindow, topDoc),
            range, $link;

        if (window.getSelection) {
            // Modern browsers, using a W3C range object
            var link = topDoc.createElement("a"),
                oldlink;

            range = getRangeObject(selection),
            $link = $(link).attr("href", url).attr("title", title ? title : null);

            if (newwindow) {
                $link.attr("target", "_blank");
            }

            if (range.collapsed) {
                $link.text(title);
                range.insertNode(link);
            } else if (selection.anchorNode.nodeType===Node.ELEMENT_NODE &&
                      selection.anchorNode.tagName.toLowerCase()==="a") {
                oldlink = selection.anchorNode;

                link.innerHTML=oldlink.innerHTML;
                try {
                    oldlink.parentNode.insertBefore(link, oldlink);
                    $(oldlink).remove();
                } catch (ex) {
                    alert(ex);
                }
            } else if (selection.anchorNode.nodeType===Node.TEXT_NODE &&
                      selection.anchorNode.parentNode.nodeType===Node.ELEMENT_NODE &&
                      selection.anchorNode.parentNode.tagName.toLowerCase()==="a") {
                // Safari bug: selection.selectAllChildren should include the top node
                // as well, but instead only its children are added.
                oldlink = selection.anchorNode.parentNode;

                link.innerHTML=oldlink.innerHTML;
                try {
                    oldlink.parentNode.insertBefore(link, oldlink);
                    $(oldlink).remove();
                } catch (e) {
                    alert(e);
                }
            } else {
                try {
                    range.surroundContents(link);
                } catch(err) {
                    /* Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=520001 */
                    link.appendChild(range.extractContents());
                    range.insertNode(link);
                    range.selectNode(link);
                }
            }
        } else {
            // Special code path for IE
            range=selection;
            $link = $(range.parentElement()).closest("a");

            if ($link.length) {
                // The selection is inside a link, so update it
                $link
                    .attr("href", url)
                    .attr("target", newwindow ? "_blank" : null)
                    .attr("title", title ? title : null);
            } else {
                range.execCommand("CreateLink", false, url);
                $link=$(range.parentElement());
                if (title) {
                    $link.attr("title", title);
                }
                if (newwindow) {
                    $link.attr("target", "_blank");
                }
                if (range.text==="") {
                  $link.text(url);
                }
            }
        }
    }

    $("button.cancel").live("click", hide);

    $("button.save").live("click", function() {
        var form = this.form,
            link = form["form.widgets.URL"].value,
            title = form["form.widgets.title"].value,
            newwindow = form["form.widgets.new_window:list"].checked;
        if (link.indexOf(":")===-1 && link[0]!=="/") {
            link="http://"+link;
        }
        InsertURL(link, title, newwindow);
        hide();
    });
// ]]>
    </script>
  </body>
</html>
